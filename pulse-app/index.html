<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Real-time global intelligence monitoring platform">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>PULSE | Global Intelligence Monitor</title>
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/icon-192.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Audio for alerts -->
    <audio id="alert-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2NkpKLgHRpYGBqd4OQlpOLfnJnYmRufIqWmZSNgXVpZGhxgI2ZnZiShn1waGhtfIybo6GZjoF1bGtugY6cp6SdkYV6cXF2hJSjq6ifk4d8dXZ8i5qosqylmY2Ce3p/i5qstbetopWJgH2Cj52wvLqxppmNhIKGk6K0wMC3rKCUi4aIlKW4xMbAta2hlo2Kj5uqvMrLw7ivoJePjZOgssDQ0MjBtqqhlo+Ol6O2xdPU0Mm+tKykmJKTnqu+zNjZ1My/t6+pm5aWoK3B0NrczMW+t7GonZqcpbPF1d3e1svFvrqypqGgo6++zNjf4NbNxsC9uK6op6exwM/a4+Pd1s7Iw7+6sKuprLXE0t3k5t/X0czHwr22sK2us7/N2eDn6OHa1M/Lx8K7t7S0ucXS3OXp6uPd19LPy8bBvby7wMrW3+fp6+Xg2tXSz8zHw8HCx87Z4ujr7Ofl4NvX1NHQAQAAAMAAAADIAAAAAA==" type="audio/wav">
    </audio>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'bg-primary': 'var(--bg-primary)',
                        'bg-secondary': 'var(--bg-secondary)',
                        'bg-tertiary': 'var(--bg-tertiary)',
                        'border-primary': 'var(--border-primary)',
                        'border-secondary': 'var(--border-secondary)',
                        'text-primary': 'var(--text-primary)',
                        'text-secondary': 'var(--text-secondary)',
                        'text-muted': 'var(--text-muted)',
                        'accent': '#ff6600',
                        'critical': '#cc0000',
                        'warning': '#cc8800',
                        'elevated': '#aaaa00',
                        'normal': '#00aa44',
                        'info': '#0077bb',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'Consolas', 'monospace'],
                    },
                }
            }
        }
    </script>
    
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0f0f0f;
            --bg-tertiary: #141414;
            --border-primary: #1e1e1e;
            --border-secondary: #2a2a2a;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --text-muted: #606060;
        }
        
        .light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --border-primary: #e0e0e0;
            --border-secondary: #d0d0d0;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #888888;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #root { height: 100%; width: 100%; overflow: hidden; }
        body { background: var(--bg-primary); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-secondary); border-radius: 3px; }
        
        .leaflet-container { background: var(--bg-primary) !important; }
        .leaflet-control-zoom, .leaflet-control-attribution { display: none !important; }
        .leaflet-popup-content-wrapper { background: var(--bg-tertiary) !important; border: 1px solid var(--border-secondary) !important; border-radius: 2px !important; color: var(--text-primary) !important; }
        .leaflet-popup-tip { background: var(--bg-tertiary) !important; }
        .leaflet-popup-content { margin: 0 !important; font-family: 'JetBrains Mono', monospace !important; }
        
        @keyframes blink { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0.3; } }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .blink { animation: blink 1.5s ease-in-out infinite; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        
        .feed-row { border-left: 3px solid transparent; transition: background 0.1s; }
        .feed-row:hover { background: var(--bg-tertiary); }
        .feed-row.critical { border-left-color: #cc0000; }
        .feed-row.elevated { border-left-color: #aaaa00; }
        .feed-row.warning { border-left-color: #cc8800; }
        
        .status-dot { width: 6px; height: 6px; border-radius: 1px; }
        .status-dot.critical { background: #cc0000; }
        .status-dot.elevated { background: #aaaa00; }
        .status-dot.warning { background: #cc8800; }
        .status-dot.normal { background: #00aa44; }
        
        .mobile-drawer { position: fixed; top: 0; left: 0; bottom: 0; width: 320px; z-index: 1000; transform: translateX(-100%); transition: transform 0.3s ease; }
        .mobile-drawer.open { transform: translateX(0); }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .drawer-overlay.open { opacity: 1; pointer-events: auto; }
        
        .chart-container { height: 120px; }
        
        @media (max-width: 1024px) {
            .desktop-sidebar { display: none !important; }
        }
        
        @media print {
            body { background: white !important; color: black !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

        // ============ CONTEXT & CONFIG ============
        const AppContext = createContext();
        
        const DEFAULT_PREFS = {
            theme: 'dark',
            audioAlerts: true,
            notifications: false,
            refreshInterval: 60,
            criticalOnly: false,
        };

        const DEFCON = {
            1: { name: 'COCKED PISTOL', color: '#cc0000' },
            2: { name: 'FAST PACE', color: '#dd4400' },
            3: { name: 'ROUND HOUSE', color: '#cc8800' },
            4: { name: 'DOUBLE TAKE', color: '#0077bb' },
            5: { name: 'FADE OUT', color: '#00aa44' },
        };

        const ZONES = [
            { id: 1, name: 'KYIV', region: 'UKR', coords: [50.45, 30.52], level: 'critical', activity: 95 },
            { id: 2, name: 'KHARKIV', region: 'UKR', coords: [49.99, 36.23], level: 'critical', activity: 88 },
            { id: 3, name: 'GAZA', region: 'PSE', coords: [31.52, 34.45], level: 'critical', activity: 97 },
            { id: 4, name: 'RAFAH', region: 'PSE', coords: [31.28, 34.25], level: 'critical', activity: 92 },
            { id: 5, name: 'BEIRUT', region: 'LBN', coords: [33.89, 35.50], level: 'critical', activity: 78 },
            { id: 6, name: 'TEHRAN', region: 'IRN', coords: [35.69, 51.39], level: 'elevated', activity: 65 },
            { id: 7, name: 'TAIPEI', region: 'TWN', coords: [25.03, 121.57], level: 'elevated', activity: 52 },
            { id: 8, name: 'PYONGYANG', region: 'PRK', coords: [39.03, 125.75], level: 'elevated', activity: 58 },
            { id: 9, name: 'MOSCOW', region: 'RUS', coords: [55.76, 37.62], level: 'warning', activity: 70 },
            { id: 10, name: 'BEIJING', region: 'CHN', coords: [39.90, 116.41], level: 'warning', activity: 48 },
        ];

        const OSINT_ACCOUNTS = [
            { handle: 'sentdefender', name: 'OSINTdefender', focus: 'Breaking OSINT' },
            { handle: 'IntelCrab', name: 'Intel Crab', focus: 'Conflict Intel' },
            { handle: 'TheStudyofWar', name: 'ISW', focus: 'War Studies' },
            { handle: 'WarMonitors', name: 'War Monitors', focus: 'Global Conflicts' },
            { handle: 'Liveuamap', name: 'Liveuamap', focus: 'Live Mapping' },
            { handle: 'RALee85', name: 'Rob Lee', focus: 'Military Analysis' },
        ];

        const LEVEL_COLORS = { critical: '#cc0000', elevated: '#aaaa00', warning: '#cc8800', normal: '#00aa44' };

        // ============ UTILITIES ============
        const formatTime = () => new Date().toISOString().slice(0, 19).replace('T', ' ') + 'Z';
        const timeAgo = (d) => {
            const s = Math.floor((Date.now() - new Date(d)) / 1000);
            if (s < 60) return '<1m';
            if (s < 3600) return Math.floor(s / 60) + 'm';
            if (s < 86400) return Math.floor(s / 3600) + 'h';
            return Math.floor(s / 86400) + 'd';
        };
        const formatVol = (v) => v >= 1e6 ? '$' + (v/1e6).toFixed(1) + 'M' : v >= 1e3 ? '$' + (v/1e3).toFixed(0) + 'K' : '$' + v;
        
        const playAlert = () => {
            const audio = document.getElementById('alert-sound');
            if (audio) audio.play().catch(() => {});
        };

        const savePrefs = (prefs) => {
            try { localStorage.setItem('pulse-prefs', JSON.stringify(prefs)); } catch (e) {}
        };
        
        const loadPrefs = () => {
            try {
                const saved = localStorage.getItem('pulse-prefs');
                return saved ? { ...DEFAULT_PREFS, ...JSON.parse(saved) } : DEFAULT_PREFS;
            } catch (e) { return DEFAULT_PREFS; }
        };

        // ============ SERVICE WORKER & NOTIFICATIONS ============
        const registerSW = async () => {
            if ('serviceWorker' in navigator) {
                try {
                    const reg = await navigator.serviceWorker.register('/sw.js');
                    console.log('SW registered');
                    return reg;
                } catch (e) {
                    console.log('SW registration failed');
                }
            }
        };

        const requestNotifications = async () => {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return false;
        };

        const showNotification = (title, body) => {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: '/icon-192.png', badge: '/icon-192.png' });
            }
        };

        // ============ DATA HOOKS ============
        const useNews = (prefs) => {
            const [news, setNews] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(null);
            const prevCriticalCount = useRef(0);

            const fetchNews = useCallback(async () => {
                setLoading(true);
                setError(null);

                // Try Netlify function first, then fallbacks
                const endpoints = [
                    '/api/news',
                    '/.netlify/functions/news',
                ];

                let data = null;

                for (const endpoint of endpoints) {
                    try {
                        const res = await fetch(endpoint, { signal: AbortSignal.timeout(12000) });
                        if (res.ok) {
                            data = await res.json();
                            if (data.items?.length > 0) break;
                        }
                    } catch (e) {}
                }

                // Fallback to rss2json
                if (!data?.items?.length) {
                    try {
                        const feeds = [
                            { url: 'https://feeds.bbci.co.uk/news/world/rss.xml', src: 'BBC' },
                            { url: 'https://rss.nytimes.com/services/xml/rss/nyt/World.xml', src: 'NYT' },
                        ];
                        const results = [];
                        
                        for (const feed of feeds) {
                            try {
                                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}&count=10`, {
                                    signal: AbortSignal.timeout(10000)
                                });
                                if (res.ok) {
                                    const json = await res.json();
                                    if (json.items) {
                                        json.items.forEach(item => {
                                            const txt = (item.title || '').toLowerCase();
                                            let level = 'normal';
                                            if (txt.match(/killed|dead|attack|strike|bomb|war|missile|death|terror/)) level = 'critical';
                                            else if (txt.match(/military|conflict|crisis|nuclear|weapon/)) level = 'elevated';
                                            results.push({ title: item.title, link: item.link, date: item.pubDate, src: feed.src, level });
                                        });
                                    }
                                }
                            } catch (e) {}
                        }
                        
                        if (results.length > 0) {
                            results.sort((a, b) => new Date(b.date) - new Date(a.date));
                            data = { items: results };
                        }
                    } catch (e) {}
                }

                if (data?.items?.length > 0) {
                    const items = prefs.criticalOnly ? data.items.filter(i => i.level === 'critical') : data.items;
                    
                    // Check for new critical items
                    const criticalCount = items.filter(i => i.level === 'critical').length;
                    if (criticalCount > prevCriticalCount.current && prevCriticalCount.current > 0) {
                        if (prefs.audioAlerts) playAlert();
                        if (prefs.notifications) showNotification('PULSE Alert', 'New critical intelligence received');
                    }
                    prevCriticalCount.current = criticalCount;
                    
                    setNews(items.slice(0, 20));
                    setLastUpdate(new Date());
                } else {
                    setError('FEED UNAVAILABLE');
                }
                setLoading(false);
            }, [prefs.criticalOnly, prefs.audioAlerts, prefs.notifications]);

            useEffect(() => {
                fetchNews();
                const interval = setInterval(fetchNews, prefs.refreshInterval * 1000);
                return () => clearInterval(interval);
            }, [fetchNews, prefs.refreshInterval]);

            return { news, loading, error, lastUpdate, refresh: fetchNews };
        };

        const usePolymarket = (prefs) => {
            const [markets, setMarkets] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(null);
            const [history, setHistory] = useState({});

            const fetchMarkets = useCallback(async () => {
                setLoading(true);
                setError(null);

                const keywords = ['russia', 'ukraine', 'china', 'taiwan', 'iran', 'israel', 'war', 'trump', 'biden', 'fed', 'recession', 'ceasefire', 'gaza', 'nato', 'nuclear', 'military', 'election', 'tariff'];

                // Try endpoints in order
                const endpoints = [
                    '/api/polymarket',
                    '/.netlify/functions/polymarket',
                    'https://gamma-api.polymarket.com/markets?closed=false&limit=100&active=true',
                ];

                let data = null;

                for (const endpoint of endpoints) {
                    try {
                        const res = await fetch(endpoint, { signal: AbortSignal.timeout(15000) });
                        if (res.ok) {
                            const json = await res.json();
                            data = Array.isArray(json) ? json : (json.data || json.markets || []);
                            if (data.length > 0) break;
                        }
                    } catch (e) {
                        console.log('Polymarket endpoint failed:', endpoint);
                    }
                }

                if (data && data.length > 0) {
                    const filtered = data
                        .filter(m => {
                            if (!m.question) return false;
                            const q = m.question.toLowerCase();
                            return keywords.some(k => q.includes(k));
                        })
                        .map(m => {
                            let prob = 0;
                            try {
                                if (m.outcomePrices) {
                                    const prices = typeof m.outcomePrices === 'string' ? JSON.parse(m.outcomePrices) : m.outcomePrices;
                                    prob = prices[0] ? Math.round(parseFloat(prices[0]) * 100) : 0;
                                }
                            } catch (e) {}
                            
                            return { id: m.id || Math.random(), q: m.question, prob, vol: parseFloat(m.volume) || 0, slug: m.slug };
                        })
                        .filter(m => m.prob > 0 && m.prob < 100)
                        .sort((a, b) => b.vol - a.vol)
                        .slice(0, 12);

                    // Track history for charts
                    setHistory(prev => {
                        const newHist = { ...prev };
                        filtered.forEach(m => {
                            if (!newHist[m.id]) newHist[m.id] = [];
                            newHist[m.id] = [...newHist[m.id].slice(-19), m.prob];
                        });
                        return newHist;
                    });

                    setMarkets(filtered);
                    setLastUpdate(new Date());
                } else {
                    setError('MARKETS UNAVAILABLE');
                }
                setLoading(false);
            }, []);

            useEffect(() => {
                fetchMarkets();
                const interval = setInterval(fetchMarkets, 60000);
                return () => clearInterval(interval);
            }, [fetchMarkets]);

            return { markets, loading, error, lastUpdate, history, refresh: fetchMarkets };
        };

        const useMarkets = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [history, setHistory] = useState([]);

            const fetchData = useCallback(async () => {
                let btc = { usd: 103156, usd_24h_change: 2.34 };
                let eth = { usd: 3892, usd_24h_change: 1.87 };

                try {
                    const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd&include_24hr_change=true', {
                        signal: AbortSignal.timeout(8000)
                    });
                    if (res.ok) {
                        const crypto = await res.json();
                        if (crypto.bitcoin) btc = crypto.bitcoin;
                        if (crypto.ethereum) eth = crypto.ethereum;
                    }
                } catch (e) {}

                const newData = [
                    { sym: 'ES', name: 'S&P 500 FUT', val: 5996.50 + (Math.random()-0.5)*10, chg: 0.16 + (Math.random()-0.5)*0.2 },
                    { sym: 'NQ', name: 'NASDAQ FUT', val: 21250.25 + (Math.random()-0.5)*20, chg: 0.22 + (Math.random()-0.5)*0.3 },
                    { sym: 'VIX', name: 'VOLATILITY', val: 15.97 + (Math.random()-0.5)*1, chg: -3.34 + (Math.random()-0.5)*2 },
                    { sym: 'GC', name: 'GOLD', val: 2714.20 + (Math.random()-0.5)*5, chg: 0.87 + (Math.random()-0.5)*0.5 },
                    { sym: 'CL', name: 'CRUDE OIL', val: 77.88 + (Math.random()-0.5)*1, chg: 1.28 + (Math.random()-0.5)*1 },
                    { sym: 'DXY', name: 'USD INDEX', val: 108.25 + (Math.random()-0.5)*0.5, chg: 0.12 + (Math.random()-0.5)*0.2 },
                    { sym: 'BTC', name: 'BITCOIN', val: btc.usd, chg: btc.usd_24h_change || 0 },
                    { sym: 'ETH', name: 'ETHEREUM', val: eth.usd, chg: eth.usd_24h_change || 0 },
                ];

                // Track BTC history for chart
                setHistory(prev => [...prev.slice(-29), btc.usd]);
                setData(newData);
                setLoading(false);
            }, []);

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 30000);
                return () => clearInterval(interval);
            }, [fetchData]);

            return { data, loading, history };
        };

        // ============ EXPORT FUNCTIONS ============
        const exportCSV = (news, markets) => {
            let csv = 'Type,Time,Source,Title/Question,Level/Probability\n';
            
            news.forEach(n => {
                csv += `News,"${n.date}","${n.src}","${n.title.replace(/"/g, '""')}","${n.level}"\n`;
            });
            
            markets.forEach(m => {
                csv += `Market,,"Polymarket","${m.q.replace(/"/g, '""')}","${m.prob}%"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pulse-report-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const exportJSON = (news, markets, zones) => {
            const report = {
                generated: new Date().toISOString(),
                version: '10.0',
                intel: news,
                predictions: markets,
                threatZones: zones,
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pulse-report-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // ============ COMPONENTS ============
        const Header = ({ time, prefs, setPrefs, onMenuClick, onExport }) => (
            <header className="h-10 bg-[var(--bg-secondary)] border-b border-[var(--border-primary)] flex items-center justify-between px-3">
                <div className="flex items-center gap-3">
                    <button onClick={onMenuClick} className="lg:hidden p-1 hover:bg-[var(--bg-tertiary)] rounded">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <span className="text-[#ff6600] font-semibold text-sm">PULSE</span>
                    <span className="text-[var(--text-muted)] text-xs hidden sm:inline">v10.0</span>
                    <div className="flex items-center gap-1.5 ml-2">
                        <span className="status-dot normal blink"></span>
                        <span className="text-xs text-[#00aa44]">ONLINE</span>
                    </div>
                </div>
                <div className="flex items-center gap-2">
                    <button onClick={() => { const newTheme = prefs.theme === 'dark' ? 'light' : 'dark'; setPrefs(p => ({ ...p, theme: newTheme })); }}
                        className="p-1.5 hover:bg-[var(--bg-tertiary)] rounded text-[var(--text-muted)] hover:text-[var(--text-primary)]" title="Toggle theme">
                        {prefs.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
                    </button>
                    <button onClick={() => setPrefs(p => ({ ...p, audioAlerts: !p.audioAlerts }))}
                        className="p-1.5 hover:bg-[var(--bg-tertiary)] rounded text-[var(--text-muted)] hover:text-[var(--text-primary)]" title="Toggle audio">
                        {prefs.audioAlerts ? 'üîî' : 'üîï'}
                    </button>
                    <button onClick={onExport} className="hidden sm:block text-[10px] px-2 py-1 bg-[var(--bg-tertiary)] hover:bg-[var(--border-secondary)] rounded text-[var(--text-secondary)]">
                        EXPORT
                    </button>
                    <span className="text-xs text-[var(--text-secondary)] font-mono hidden md:inline">{time}</span>
                </div>
            </header>
        );

        const DefconBar = ({ level = 3 }) => (
            <div className="h-7 bg-[var(--bg-tertiary)] border-b border-[var(--border-primary)] flex items-center justify-between px-3 text-xs">
                <div className="flex items-center gap-2">
                    <span className="text-[var(--text-muted)]">DEFCON:</span>
                    <div className="flex gap-0.5">
                        {[1,2,3,4,5].map(l => (
                            <span key={l} className={`w-4 h-4 flex items-center justify-center rounded-sm text-[10px] ${l === level ? 'text-white font-semibold' : 'text-[var(--text-muted)]'}`}
                                style={{ backgroundColor: l === level ? DEFCON[l].color : 'transparent', border: l === level ? 'none' : '1px solid var(--border-secondary)' }}>{l}</span>
                        ))}
                    </div>
                    <span className="hidden sm:inline ml-1" style={{ color: DEFCON[level].color }}>{DEFCON[level].name}</span>
                </div>
                <div className="flex items-center gap-2">
                    <span className="text-[var(--text-muted)]">CRIT:</span>
                    <span className="text-[#cc0000] font-semibold">{ZONES.filter(z => z.level === 'critical').length}</span>
                </div>
            </div>
        );

        const AlertTicker = ({ news }) => {
            const alerts = news.filter(n => n.level === 'critical').slice(0, 5);
            const msgs = alerts.length > 0 ? alerts.map(n => `[${n.src}] ${n.title}`) : ['MONITORING...'];
            
            return (
                <div className="h-6 bg-[#cc0000]/10 border-b border-[#cc0000]/30 flex items-center overflow-hidden text-[11px]">
                    <div className="flex items-center gap-1 px-2 bg-[#cc0000]/20 h-full shrink-0">
                        <span className="status-dot critical blink"></span>
                        <span className="text-[#cc0000] font-medium">ALERT</span>
                    </div>
                    <div className="flex-1 overflow-hidden">
                        <div className="flex whitespace-nowrap" style={{ animation: 'ticker 120s linear infinite' }}>
                            {[...msgs, ...msgs].map((m, i) => <span key={i} className="text-[#cc0000]/80 mx-6">{m}</span>)}
                        </div>
                    </div>
                </div>
            );
        };

        const Panel = ({ title, status, extra, children, onRefresh, loading, error }) => (
            <div className="bg-[var(--bg-secondary)] border border-[var(--border-primary)] flex flex-col h-full rounded-sm overflow-hidden">
                <div className="h-7 px-2 flex items-center justify-between border-b border-[var(--border-primary)] bg-[var(--bg-tertiary)] shrink-0">
                    <div className="flex items-center gap-2">
                        <span className="text-[10px] font-semibold text-[#ff6600]">{title}</span>
                        {status && <span className={`text-[9px] px-1 rounded ${status === 'LIVE' ? 'bg-[#00aa44]/20 text-[#00aa44]' : status === 'ERROR' ? 'bg-[#cc0000]/20 text-[#cc0000]' : 'bg-[#0077bb]/20 text-[#0077bb]'}`}>{status}</span>}
                        {loading && <span className="text-[9px] text-[var(--text-muted)]">...</span>}
                    </div>
                    <div className="flex items-center gap-2">
                        {extra}
                        {onRefresh && <button onClick={onRefresh} className="text-[9px] text-[var(--text-muted)] hover:text-[#ff6600]">[‚Üª]</button>}
                    </div>
                </div>
                <div className="flex-1 overflow-auto">
                    {error ? (
                        <div className="p-3 text-center">
                            <p className="text-[11px] text-[#cc0000]">{error}</p>
                            {onRefresh && <button onClick={onRefresh} className="text-[10px] text-[#ff6600] mt-1">[RETRY]</button>}
                        </div>
                    ) : children}
                </div>
            </div>
        );

        const ThreatMap = () => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const { prefs } = useContext(AppContext);

            useEffect(() => {
                if (!mapRef.current || mapInstance.current) return;
                
                const map = L.map(mapRef.current, { center: [32, 30], zoom: 2.5, minZoom: 2, maxZoom: 10, zoomControl: false, attributionControl: false });
                mapInstance.current = map;

                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd' }).addTo(map);

                const heatData = [];
                ZONES.forEach(z => {
                    const w = z.level === 'critical' ? 1.0 : z.level === 'elevated' ? 0.6 : 0.4;
                    heatData.push([z.coords[0], z.coords[1], w]);
                    for (let i = 0; i < 4; i++) heatData.push([z.coords[0] + (Math.random()-0.5)*3, z.coords[1] + (Math.random()-0.5)*3, w*0.4]);
                });
                L.heatLayer(heatData, { radius: 28, blur: 18, gradient: { 0.2: '#003355', 0.4: '#006699', 0.6: '#cc8800', 0.8: '#cc4400', 1.0: '#cc0000' } }).addTo(map);

                ZONES.forEach(z => {
                    L.circleMarker(z.coords, { radius: 5, fillColor: LEVEL_COLORS[z.level], color: '#fff', weight: 1, fillOpacity: 0.9 })
                        .addTo(map)
                        .bindPopup(`<div style="padding:8px;font-size:11px;min-width:120px;"><div style="color:${LEVEL_COLORS[z.level]};font-weight:600;">${z.level.toUpperCase()}</div><div style="font-size:12px;font-weight:600;margin:4px 0;">${z.name}</div><div style="color:#888;">${z.region} | ${z.activity}%</div></div>`);
                });

                return () => { mapInstance.current?.remove(); mapInstance.current = null; };
            }, []);

            return (
                <div className="relative h-full bg-[var(--bg-primary)] border border-[var(--border-primary)] overflow-hidden rounded-sm">
                    <div ref={mapRef} className="absolute inset-0" />
                    <div className="absolute top-2 left-2 bg-[var(--bg-secondary)]/95 border border-[var(--border-primary)] p-2 z-[1000] text-[10px] rounded-sm">
                        <div className="text-[#ff6600] font-semibold mb-1">STATUS</div>
                        <div className="space-y-0.5">
                            <div className="flex justify-between gap-3"><span className="flex items-center gap-1"><span className="status-dot critical"></span>CRIT</span><span className="text-[#cc0000]">{ZONES.filter(z=>z.level==='critical').length}</span></div>
                            <div className="flex justify-between gap-3"><span className="flex items-center gap-1"><span className="status-dot elevated"></span>ELEV</span><span className="text-[#aaaa00]">{ZONES.filter(z=>z.level==='elevated').length}</span></div>
                            <div className="flex justify-between gap-3"><span className="flex items-center gap-1"><span className="status-dot warning"></span>WARN</span><span className="text-[#cc8800]">{ZONES.filter(z=>z.level==='warning').length}</span></div>
                        </div>
                    </div>
                </div>
            );
        };

        const IntelFeed = () => {
            const { prefs } = useContext(AppContext);
            const { news, loading, error, lastUpdate, refresh } = useNews(prefs);

            return (
                <Panel title="INTEL FEED" status={error ? 'ERROR' : news.length ? 'LIVE' : null} extra={lastUpdate && <span className="text-[9px] text-[var(--text-muted)]">{lastUpdate.toLocaleTimeString()}</span>} onRefresh={refresh} loading={loading} error={error}>
                    <div className="p-1">
                        {news.map((item, i) => (
                            <a key={i} href={item.link} target="_blank" rel="noopener noreferrer" className={`feed-row ${item.level} flex items-start gap-1.5 p-1 hover:bg-[var(--bg-tertiary)]`}>
                                <span className="text-[9px] text-[var(--text-muted)] w-5 shrink-0 text-right">{timeAgo(item.date)}</span>
                                <span className="text-[9px] text-[#ff6600] w-7 shrink-0">{item.src}</span>
                                <span className="text-[11px] text-[var(--text-secondary)] leading-snug line-clamp-2">{item.title}</span>
                            </a>
                        ))}
                    </div>
                </Panel>
            );
        };

        const OsintPanel = () => (
            <Panel title="OSINT SOURCES" status="LINKS">
                <div className="p-2 space-y-1">
                    {OSINT_ACCOUNTS.map(acc => (
                        <a key={acc.handle} href={`https://x.com/${acc.handle}`} target="_blank" rel="noopener noreferrer" className="block p-1.5 bg-[var(--bg-tertiary)] hover:bg-[var(--border-primary)] rounded-sm border border-[var(--border-primary)]">
                            <div className="flex justify-between items-center">
                                <span className="text-[10px] text-[#ff6600]">@{acc.handle}</span>
                                <span className="text-[9px] text-[var(--text-muted)]">[‚Üí]</span>
                            </div>
                            <p className="text-[9px] text-[var(--text-muted)]">{acc.focus}</p>
                        </a>
                    ))}
                    <div className="pt-2 border-t border-[var(--border-primary)]">
                        <div className="text-[9px] text-[var(--text-muted)] mb-1">SEARCHES:</div>
                        <div className="flex flex-wrap gap-1">
                            {['#Ukraine', '#Gaza', '#OSINT'].map(tag => (
                                <a key={tag} href={`https://x.com/search?q=${tag}&f=live`} target="_blank" rel="noopener noreferrer" className="text-[9px] px-1.5 py-0.5 bg-[#cc0000]/10 text-[#cc0000] border border-[#cc0000]/20 rounded-sm hover:bg-[#cc0000]/20">{tag}</a>
                            ))}
                        </div>
                    </div>
                </div>
            </Panel>
        );

        const PredictionTerminal = () => {
            const { prefs } = useContext(AppContext);
            const { markets, loading, error, lastUpdate, history, refresh } = usePolymarket(prefs);

            return (
                <Panel title="PREDICTIONS" status={error ? 'ERROR' : markets.length ? 'POLYMARKET' : null} extra={lastUpdate && <span className="text-[9px] text-[var(--text-muted)]">{lastUpdate.toLocaleTimeString()}</span>} onRefresh={refresh} loading={loading} error={error}>
                    <div className="p-1">
                        <div className="flex text-[8px] text-[var(--text-muted)] px-1.5 py-0.5 border-b border-[var(--border-primary)] bg-[var(--bg-tertiary)]">
                            <span className="flex-1">CONTRACT</span>
                            <span className="w-10 text-right">PROB</span>
                            <span className="w-12 text-right">VOL</span>
                        </div>
                        {markets.map((m, i) => (
                            <a key={m.id} href={m.slug ? `https://polymarket.com/event/${m.slug}` : '#'} target="_blank" rel="noopener noreferrer" className="flex items-center px-1.5 py-1.5 border-b border-[var(--border-primary)] hover:bg-[var(--bg-tertiary)] text-[10px]">
                                <span className="flex-1 text-[var(--text-secondary)] leading-tight pr-1 line-clamp-2">{m.q}</span>
                                <span className={`w-10 text-right font-semibold ${m.prob >= 50 ? 'text-[#cc0000]' : m.prob >= 25 ? 'text-[#aaaa00]' : 'text-[#00aa44]'}`}>{m.prob}%</span>
                                <span className="w-12 text-right text-[var(--text-muted)] text-[9px]">{formatVol(m.vol)}</span>
                            </a>
                        ))}
                    </div>
                </Panel>
            );
        };

        const MarketTerminal = () => {
            const { data, loading, history } = useMarkets();
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || history.length < 2) return;
                
                if (chartInstance.current) {
                    chartInstance.current.data.labels = history.map((_, i) => i);
                    chartInstance.current.data.datasets[0].data = history;
                    chartInstance.current.update('none');
                    return;
                }

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'line',
                    data: { labels: history.map((_, i) => i), datasets: [{ data: history, borderColor: '#00aa44', backgroundColor: 'rgba(0,170,68,0.1)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, animation: false }
                });

                return () => { chartInstance.current?.destroy(); chartInstance.current = null; };
            }, [history]);

            const formatVal = (sym, val) => {
                if (['BTC', 'ETH'].includes(sym)) return val.toLocaleString(undefined, { maximumFractionDigits: 0 });
                if (['VIX', 'DXY'].includes(sym)) return val.toFixed(2);
                return val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            return (
                <Panel title="MARKETS" status="LIVE" loading={loading}>
                    <div className="p-1">
                        {history.length > 2 && (
                            <div className="mb-2 p-1.5 bg-[var(--bg-tertiary)] rounded-sm border border-[var(--border-primary)]">
                                <div className="flex justify-between text-[9px] mb-1">
                                    <span className="text-[var(--text-muted)]">BTC/USD</span>
                                    <span className="text-[#00aa44]">${history[history.length-1]?.toLocaleString()}</span>
                                </div>
                                <div className="h-12"><canvas ref={chartRef}></canvas></div>
                            </div>
                        )}
                        <div className="flex text-[8px] text-[var(--text-muted)] px-1.5 py-0.5 border-b border-[var(--border-primary)] bg-[var(--bg-tertiary)]">
                            <span className="w-8">SYM</span>
                            <span className="flex-1">NAME</span>
                            <span className="w-16 text-right">LAST</span>
                            <span className="w-12 text-right">CHG%</span>
                        </div>
                        {data.map((d, i) => (
                            <div key={i} className="flex items-center px-1.5 py-1 border-b border-[var(--border-primary)] text-[10px]">
                                <span className="w-8 text-[#ff6600] font-semibold">{d.sym}</span>
                                <span className="flex-1 text-[var(--text-muted)] text-[9px]">{d.name}</span>
                                <span className="w-16 text-right text-[var(--text-primary)]">{formatVal(d.sym, d.val)}</span>
                                <span className={`w-12 text-right font-semibold ${d.chg >= 0 ? 'text-[#00aa44]' : 'text-[#cc0000]'}`}>{d.chg >= 0 ? '+' : ''}{d.chg.toFixed(2)}%</span>
                            </div>
                        ))}
                    </div>
                </Panel>
            );
        };

        const MobileDrawer = ({ open, onClose, children }) => (
            <>
                <div className={`drawer-overlay ${open ? 'open' : ''}`} onClick={onClose}></div>
                <div className={`mobile-drawer bg-[var(--bg-secondary)] border-r border-[var(--border-primary)] ${open ? 'open' : ''}`}>
                    <div className="h-10 px-3 flex items-center justify-between border-b border-[var(--border-primary)]">
                        <span className="text-[#ff6600] font-semibold text-sm">PULSE</span>
                        <button onClick={onClose} className="p-1 hover:bg-[var(--bg-tertiary)] rounded">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div className="p-2 space-y-2 overflow-auto h-[calc(100%-40px)]">{children}</div>
                </div>
            </>
        );

        const StatusBar = ({ time }) => (
            <div className="h-6 bg-[var(--bg-tertiary)] border-t border-[var(--border-primary)] flex items-center justify-between px-3 text-[9px]">
                <div className="flex items-center gap-3">
                    <span className="flex items-center gap-1"><span className="status-dot normal"></span>OK</span>
                    <span className="text-[var(--text-muted)] hidden sm:inline">ZONES:{ZONES.length} | FEEDS:4</span>
                </div>
                <div className="flex items-center gap-3 text-[var(--text-muted)]">
                    <span className="hidden sm:inline">{time}</span>
                    <span>UNCLASSIFIED</span>
                </div>
            </div>
        );

        // ============ APP ============
        const App = () => {
            const [time, setTime] = useState(formatTime());
            const [prefs, setPrefs] = useState(loadPrefs);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const { news } = useNews(prefs);
            const { markets } = usePolymarket(prefs);

            // Apply theme
            useEffect(() => {
                document.body.classList.toggle('light-mode', prefs.theme === 'light');
            }, [prefs.theme]);

            // Save prefs
            useEffect(() => { savePrefs(prefs); }, [prefs]);

            // Register service worker
            useEffect(() => { registerSW(); }, []);

            // Clock
            useEffect(() => {
                const t = setInterval(() => setTime(formatTime()), 1000);
                return () => clearInterval(t);
            }, []);

            const handleExport = () => {
                const format = window.confirm('Export as JSON? (Cancel for CSV)');
                if (format) exportJSON(news, markets, ZONES);
                else exportCSV(news, markets);
            };

            return (
                <AppContext.Provider value={{ prefs, setPrefs }}>
                    <div className="h-screen w-screen flex flex-col overflow-hidden">
                        <Header time={time} prefs={prefs} setPrefs={setPrefs} onMenuClick={() => setDrawerOpen(true)} onExport={handleExport} />
                        <DefconBar level={3} />
                        <AlertTicker news={news} />

                        <main className="flex-1 flex overflow-hidden min-h-0">
                            {/* Desktop Left Sidebar */}
                            <aside className="desktop-sidebar w-[300px] xl:w-[340px] border-r border-[var(--border-primary)] flex-col hidden lg:flex">
                                <div className="flex-1 overflow-auto p-1.5 space-y-1.5">
                                    <div className="h-[55%]"><IntelFeed /></div>
                                    <div className="h-[45%]"><OsintPanel /></div>
                                </div>
                            </aside>

                            {/* Center Map */}
                            <section className="flex-1 p-1.5 overflow-hidden">
                                <ThreatMap />
                            </section>

                            {/* Desktop Right Sidebar */}
                            <aside className="desktop-sidebar w-[320px] xl:w-[360px] border-l border-[var(--border-primary)] flex-col hidden xl:flex">
                                <div className="flex-1 overflow-auto p-1.5 space-y-1.5">
                                    <div className="h-[55%]"><PredictionTerminal /></div>
                                    <div className="h-[45%]"><MarketTerminal /></div>
                                </div>
                            </aside>
                        </main>

                        <StatusBar time={time} />

                        {/* Mobile Drawer */}
                        <MobileDrawer open={drawerOpen} onClose={() => setDrawerOpen(false)}>
                            <div className="h-64"><IntelFeed /></div>
                            <div className="h-48"><OsintPanel /></div>
                            <div className="h-64"><PredictionTerminal /></div>
                            <div className="h-48"><MarketTerminal /></div>
                        </MobileDrawer>
                    </div>
                </AppContext.Provider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
